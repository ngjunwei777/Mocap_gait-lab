<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Gait Biodynamics Lab</title>

  <!--
    Gait Biodynamics Lab
    Copyright (c) 2025 Ng Jun Wei. All rights reserved.
    Unauthorized copying, modification, distribution, or use of this code, in whole or in part, is prohibited without prior written permission.
  -->

  <!-- TFJS + Pose Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 16px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { text-align:center; color:#667eea; margin-bottom:8px; font-size:2.1em; }
    .subtitle { text-align:center; color:#666; margin-bottom:12px; font-size: 13px; line-height:1.35; }

    .status { padding:10px; border-radius:10px; margin-bottom:12px; text-align:center; font-weight:800; }
    .status.loading { background:#fff3cd; color:#856404; }
    .status.ready { background:#d4edda; color:#155724; }
    .status.error { background:#f8d7da; color:#721c24; }

    .loading-spinner {
      display:inline-block;
      width:18px; height:18px;
      border:3px solid rgba(102,126,234,0.25);
      border-radius:50%;
      border-top-color:#667eea;
      animation:spin 1s linear infinite;
      vertical-align:-3px;
      margin-right:8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .mini-btns {
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin-top:10px;
    }
    .mini-btns button{
      padding:10px 12px;
      border:none;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
      background:#2c3e50;
      color:#fff;
      letter-spacing:0.4px;
      text-transform:uppercase;
      min-width: 160px;
    }
    .mini-btns button.alt{ background:#667eea; }
    .mini-btns button.warn{ background:#f39c12; color:#1f1f1f; }
    .mini-btns button.danger{ background:#e74c3c; }

    .info-section { padding:14px; background:#f8f9fa; border-radius:14px; }
    .info-section h3 { color:#667eea; margin-bottom:10px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap:12px; }
    label { display:block; margin-bottom:6px; font-weight:800; color:#666; }
    select, input[type="number"] {
      width:100%;
      padding:10px;
      border:2px solid #667eea;
      border-radius:10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .hint { margin-top:6px; font-size:12px; color:#666; line-height:1.35; }

    .main-content {
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
      margin-top: 14px;
    }
    @media (max-width: 968px) {
      .main-content { grid-template-columns: 1fr; }
      h1 { font-size: 1.75em; }
    }

    .video-section { position:relative; }
    #videoContainer {
      position:relative;
      width:100%;
      background:#000;
      border-radius:15px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #webcam { width:100%; display:block; background:#000; }
    #canvas {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
    }
    .fps-indicator {
      position:absolute;
      top:10px; right:10px;
      background: rgba(0,0,0,0.65);
      color:#0f0;
      padding:8px 10px;
      border-radius:10px;
      font-weight:900;
      font-size:13px;
      z-index:20;
    }

    .controls { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button.big {
      flex:1;
      min-width:160px;
      padding: 12px 12px;
      font-size: 13px;
      font-weight: 900;
      border:none;
      border-radius:12px;
      cursor:pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    button.big:disabled { opacity:0.55; cursor:not-allowed; }
    button.big:hover:not(:disabled) { transform: translateY(-1px); }

    #startCamBtn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; }
    #loadVideoBtn { background: #f39c12; color:#1f1f1f; }
    #playPauseBtn { background: #2c3e50; color:white; }
    #stopBtn { background: #e74c3c; color:white; }
    #recordBtn { background: #27ae60; color:white; }
    #recordBtn.recording { background:#e74c3c; animation:pulse 1.5s infinite; }
    #exportBtn { background: #3498db; color:white; }
    #snapshotBtn { background: #8e44ad; color:white; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }

    .analysis-panel {
      background:#f8f9fa;
      border-radius:15px;
      padding:14px;
      height: fit-content;
    }
    .pill {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:white;
      background:#667eea;
      margin-left:8px;
    }

    .gait-phase {
      background:white;
      padding:12px;
      border-radius:12px;
      margin-bottom:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    .metric-label { font-size:12px; color:#666; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px; }
    .metric-value { font-size:18px; font-weight:900; color:#222; }
    .metric-unit { font-size:13px; color:#999; margin-left:6px; font-weight:800; }

    .phase-indicator { display:flex; justify-content:space-between; margin-top:10px; }
    .phase-dot {
      width:40px; height:40px;
      border-radius:50%;
      background:#e0e0e0;
      display:flex; align-items:center; justify-content:center;
      font-size:10px; font-weight:900; color:#999;
      transition: all 0.25s ease;
    }
    .phase-dot.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      transform: scale(1.14);
    }

    .metrics { display:grid; gap:10px; margin-top:10px; }
    .metric-card {
      background:white;
      padding:12px;
      border-radius:12px;
      border-left:4px solid #667eea;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }

    .issues-list {
      background:white;
      padding:12px;
      border-radius:12px;
      max-height: 210px;
      overflow-y:auto;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    .issue-item { padding:9px; margin-bottom:8px; border-radius:9px; font-size:13px; display:flex; gap:8px; align-items:flex-start; }
    .issue-item.warning { background:#fff3cd; border-left:3px solid #ffc107; }
    .issue-item.critical { background:#f8d7da; border-left:3px solid #dc3545; }

    .tag {
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      color:#fff;
      line-height:1.6;
      white-space:nowrap;
      transform: translateY(1px);
    }
    .tag.overstrider { background:#2c3e50; }
    .tag.bouncer { background:#8e44ad; }
    .tag.collapser { background:#16a085; }
    .tag.crosser { background:#e67e22; }
    .tag.generic { background:#667eea; }

    .charts-section {
      margin-top:14px;
      padding:14px;
      background:#f8f9fa;
      border-radius:15px;
    }
    .charts-section h3 { color:#667eea; margin-bottom:12px; }
    .chart-container {
      background:white;
      padding:14px;
      border-radius:12px;
      margin-bottom:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    .chart-wrap { height: 260px; }
    .chart-wrap.tall { height: 320px; }
    .chart-container canvas { width:100% !important; height:100% !important; }

    .tiny { font-size:12px; color:#666; margin-top:10px; line-height:1.35; }
    .row-note { margin-top:8px; font-size:12px; color:#666; }

    .video-controls {
      margin-top: 12px;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      display: none;
    }
    .vc-row { display:grid; gap:10px; }
    .seek-row {
      display:grid;
      grid-template-columns: 90px 1fr 140px;
      gap:10px;
      align-items:center;
    }
    input[type="range"] { width:100%; }
    .vc-buttons { display:flex; gap:10px; flex-wrap:wrap; }
    .vc-buttons button {
      min-width: 140px;
      flex: 1;
      padding: 10px 12px;
      font-size: 13px;
      border:none;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
      background:#2c3e50;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:0.4px;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      color: #333;
    }
    .step-select {
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .step-select select {
      padding: 10px;
      border: 2px solid #667eea;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      width: 100%;
      background:#fff;
    }

    footer {
      margin-top: 12px;
      text-align:center;
      color:#666;
      font-size:12px;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>üèÉ Gait Biodynamics Lab</h1>
  <p class="subtitle">
    Camera + Upload High-FPS Video ‚Ä¢ Per-step GRF proxy curves ‚Ä¢ Developed by Ng Jun Wei<br>
    <span class="mono">If init freezes, use the buttons that appear to force WebGL/CPU.</span>
  </p>

  <div id="status" class="status loading">
    <span class="loading-spinner"></span> Initializing‚Ä¶
  </div>

  <div id="initFallback" class="mini-btns" style="display:none;">
    <button class="alt" id="retryInitBtn">Retry Init</button>
    <button class="warn" id="forceWebglBtn">Force WebGL</button>
    <button class="danger" id="forceCpuBtn">Force CPU</button>
  </div>

  <div class="info-section">
    <h3>üë§ Subject & View</h3>
    <div class="grid">
      <div>
        <label>View Mode</label>
        <select id="viewMode">
          <option value="sagittal" selected>Sagittal (Side View)</option>
          <option value="frontal">Frontal (Front/Back View)</option>
        </select>
        <div class="hint">Sagittal: overstride ‚Ä¢ Frontal: pelvic tilt + knee drift + crossover gait.</div>
      </div>
      <div>
        <label>Sex</label>
        <select id="subjectSex">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div>
        <label>Age (years)</label>
        <input type="number" id="subjectAge" min="1" max="120" value="30">
      </div>
      <div>
        <label>Mass (kg)</label>
        <input type="number" id="subjectMass" min="20" max="300" step="0.1" value="70">
      </div>
      <div>
        <label>Height (cm) (used for spatial calibration)</label>
        <input type="number" id="subjectHeight" min="100" max="250" step="0.1" value="170">
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="video-section">
      <div id="videoContainer">
        <div class="fps-indicator" id="fpsDisplay">FPS: 0</div>
        <video id="webcam" playsinline muted></video>
        <canvas id="canvas"></canvas>
      </div>

      <div class="controls">
        <button class="big" id="startCamBtn" disabled>Start Camera</button>
        <button class="big" id="loadVideoBtn" disabled>Upload Video</button>
        <button class="big" id="playPauseBtn" disabled>Play</button>
        <button class="big" id="stopBtn" disabled>Stop</button>
        <button class="big" id="recordBtn" disabled>Start Recording</button>
        <button class="big" id="exportBtn" disabled>Export XLSX</button>
        <button class="big" id="snapshotBtn" disabled>Snapshot PNG</button>
      </div>

      <div class="video-controls" id="videoControlsPanel">
        <div class="vc-row">
          <div class="seek-row">
            <div class="mono">Seek</div>
            <input id="seekBar" type="range" min="0" max="1000" value="0" step="1">
            <div class="mono" id="timeLabel">0.000 / 0.000</div>
          </div>

          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px;">
            <div>
              <label>Assumed Video FPS (for frame-step)</label>
              <input id="assumedFps" type="number" min="10" max="1000" step="1" value="240">
            </div>
            <div>
              <label>Frame Step Size</label>
              <select id="frameStepMode">
                <option value="1" selected>¬±1 frame</option>
                <option value="2">¬±2 frames</option>
                <option value="5">¬±5 frames</option>
              </select>
            </div>
          </div>

          <div class="vc-buttons">
            <button id="stepBackBtn" disabled>‚óÄÔ∏é -Frame</button>
            <button id="stepFwdBtn" disabled>Frame+ ‚ñ∂Ô∏é</button>
            <button id="skipBackBtn" disabled>‚óÄÔ∏é -0.1s</button>
            <button id="skipFwdBtn" disabled>+0.1s ‚ñ∂Ô∏é</button>
          </div>

          <div class="mono" id="videoMetaLabel">Video: (not loaded)</div>
        </div>
      </div>

      <input id="videoFile" type="file" accept="video/*" style="display:none;">
      <div class="row-note" id="sourceNote">Source: none</div>
    </div>

    <div class="analysis-panel">
      <h3 style="color:#667eea; margin-bottom:10px;">
        Real-Time (Per-Step)
        <span class="pill" id="modePill">SAGITTAL</span>
        <span class="pill" id="sourcePill" style="background:#2c3e50;">NONE</span>
      </h3>

      <div class="gait-phase">
        <div class="metric-label">Current Phase</div>
        <div class="metric-value" id="gaitPhase">Standing</div>
        <div class="phase-indicator">
          <div class="phase-dot" id="phase1">IC</div>
          <div class="phase-dot" id="phase2">MS</div>
          <div class="phase-dot" id="phase3">TO</div>
          <div class="phase-dot" id="phase4">SW</div>
        </div>
        <div class="tiny" style="margin-top:10px;">IC: Initial Contact ‚Ä¢ MS: Mid Stance ‚Ä¢ TO: Toe Off ‚Ä¢ SW: Swing</div>
      </div>

      <div class="metrics">
        <div class="metric-card">
          <div class="metric-label">Cadence (last ~8 IC)</div>
          <div class="metric-value" id="cadence">0<span class="metric-unit">steps/min</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Stance Time Avg (last ~6)</div>
          <div class="metric-value" id="stanceTime">0<span class="metric-unit">s</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Swing Time Avg (last ~6)</div>
          <div class="metric-value" id="swingTime">0<span class="metric-unit">s</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Stride Length Avg (last ~6)</div>
          <div class="metric-value" id="strideLength">0<span class="metric-unit">cm</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Knee Flexion Mid-Stance (L) - last</div>
          <div class="metric-value" id="kneeMSL">0<span class="metric-unit">¬∞</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Knee Flexion Mid-Stance (R) - last</div>
          <div class="metric-value" id="kneeMSR">0<span class="metric-unit">¬∞</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Pelvic Tilt (Lateral) - last</div>
          <div class="metric-value" id="pelvicTilt">0<span class="metric-unit">¬∞</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Vertical Oscillation (VO) - live</div>
          <div class="metric-value" id="vertOsc">0<span class="metric-unit">cm</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label" id="modeMetricLabel">Overstride Risk (last IC)</div>
          <div class="metric-value" id="modeMetricValue">Low</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">GRF Peak (last step, proxy)</div>
          <div class="metric-value" id="grfPeak">0<span class="metric-unit">BW</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">GRF Time-to-Peak (last step, proxy)</div>
          <div class="metric-value" id="grfTTP">0<span class="metric-unit">ms</span></div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="metric-label">Detected Issues (per-step)</div>
        <div class="issues-list" id="issuesList">
          <div style="text-align:center; color:#999; padding:18px;">No issues detected yet</div>
        </div>
      </div>

      <div class="tiny">
        GRF proxy curve uses ankle vertical deceleration during stance (normalized to BW proxy). Not a force plate.
      </div>
    </div>
  </div>

  <div class="charts-section">
    <h3>üìä Charts (low-pass smoothed)</h3>

    <div class="chart-container">
      <div class="chart-wrap"><canvas id="strideChart"></canvas></div>
    </div>

    <div class="chart-container">
      <div class="chart-wrap"><canvas id="stanceChart"></canvas></div>
    </div>

    <div class="chart-container">
      <div class="chart-wrap"><canvas id="kneeMSChart"></canvas></div>
    </div>

    <div class="chart-container">
      <div class="step-select">
        <div class="mono">GRF Curve Step</div>
        <select id="stepPicker">
          <option value="">(no steps yet)</option>
        </select>
      </div>
      <div class="chart-wrap tall"><canvas id="grfCurveChart"></canvas></div>
      <div class="tiny">Selected step‚Äôs stance GRF proxy curve (BW vs time from IC), lightly smoothed.</div>
    </div>
  </div>

  <footer>Copyright ¬© 2025 Ng Jun Wei. All rights reserved.</footer>
</div>

<script>
  // ===========================
  // HARDENING: show *all* errors
  // ===========================
  const statusDiv = document.getElementById('status');
  const initFallback = document.getElementById('initFallback');
  function setStatus(type, html){
    statusDiv.className = 'status ' + type;
    statusDiv.innerHTML = html;
  }
  window.addEventListener('error', (e)=>{
    console.error('window.error:', e.error || e.message);
    initFallback.style.display = 'flex';
    setStatus('error', '‚úó Error: ' + (e.error?.message || e.message || 'unknown'));
  });
  window.addEventListener('unhandledrejection', (e)=>{
    console.error('unhandledrejection:', e.reason);
    initFallback.style.display = 'flex';
    setStatus('error', '‚úó Promise rejected: ' + (e.reason?.message || String(e.reason)));
  });

  // ============================================================
  // Environment
  // ============================================================
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  const useVFC = typeof HTMLVideoElement !== 'undefined' && 'requestVideoFrameCallback' in HTMLVideoElement.prototype;

  // ============================================================
  // DOM
  // ============================================================
  const fpsDisplay = document.getElementById('fpsDisplay');
  const startCamBtn = document.getElementById('startCamBtn');
  const loadVideoBtn = document.getElementById('loadVideoBtn');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const recordBtn = document.getElementById('recordBtn');
  const exportBtn = document.getElementById('exportBtn');
  const snapshotBtn = document.getElementById('snapshotBtn');

  const videoFile = document.getElementById('videoFile');
  const webcam = document.getElementById('webcam');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const viewModeEl = document.getElementById('viewMode');
  const modePill = document.getElementById('modePill');
  const sourcePill = document.getElementById('sourcePill');
  const sourceNote = document.getElementById('sourceNote');
  const modeMetricLabel = document.getElementById('modeMetricLabel');
  const modeMetricValue = document.getElementById('modeMetricValue');

  const subjectSexEl = document.getElementById('subjectSex');
  const subjectAgeEl = document.getElementById('subjectAge');
  const subjectMassEl = document.getElementById('subjectMass');
  const subjectHeightEl = document.getElementById('subjectHeight');

  const videoControlsPanel = document.getElementById('videoControlsPanel');
  const seekBar = document.getElementById('seekBar');
  const timeLabel = document.getElementById('timeLabel');
  const assumedFpsEl = document.getElementById('assumedFps');
  const frameStepModeEl = document.getElementById('frameStepMode');
  const stepBackBtn = document.getElementById('stepBackBtn');
  const stepFwdBtn = document.getElementById('stepFwdBtn');
  const skipBackBtn = document.getElementById('skipBackBtn');
  const skipFwdBtn = document.getElementById('skipFwdBtn');
  const videoMetaLabel = document.getElementById('videoMetaLabel');

  const stepPicker = document.getElementById('stepPicker');

  const retryInitBtn = document.getElementById('retryInitBtn');
  const forceWebglBtn = document.getElementById('forceWebglBtn');
  const forceCpuBtn = document.getElementById('forceCpuBtn');

  // ============================================================
  // State
  // ============================================================
  let detector = null;
  let sourceMode = 'none';
  let mediaStream = null;
  let videoObjectUrl = null;

  let isRunning = false;
  let isRecording = false;

  let animId = null;
  let vfcActive = false;

  let loopFrames = 0;
  let loopFpsT0 = 0;

  // ============================================================
  // Init watchdog (prevents ‚Äústuck initializing forever‚Äù)
  // ============================================================
  let initWatchdog = null;
  function armInitWatchdog(){
    clearTimeout(initWatchdog);
    initWatchdog = setTimeout(()=>{
      initFallback.style.display = 'flex';
      setStatus('error',
        '‚ö†Ô∏è Init is taking too long on this device.<br>' +
        'Tap <b>Force WebGL</b> or <b>Force CPU</b> to continue.'
      );
    }, 9000);
  }
  function disarmInitWatchdog(){
    clearTimeout(initWatchdog);
    initWatchdog = null;
  }

  // ============================================================
  // Force-backend init options (for iPhone Safari)
  // ============================================================
  let backendPreference = null; // null=auto, 'webgl', 'cpu'

  retryInitBtn.addEventListener('click', ()=> boot(true));
  forceWebglBtn.addEventListener('click', ()=> { backendPreference='webgl'; boot(true); });
  forceCpuBtn.addEventListener('click', ()=> { backendPreference='cpu'; boot(true); });

  // ============================================================
  // Sex thresholds
  // ============================================================
  const TH = {
    male: { pelvicTiltWarn: 8, pelvicTiltCrit: 12, voWarnCm: 10, voCritCm: 13, overModerate: 0.20, overHigh: 0.30, crossoverWarnHipW: 0.12, crossoverCritHipW: 0.18 },
    female:{ pelvicTiltWarn:10, pelvicTiltCrit:14, voWarnCm: 11, voCritCm: 14, overModerate: 0.18, overHigh: 0.28, crossoverWarnHipW: 0.10, crossoverCritHipW: 0.16 }
  };

  // ============================================================
  // Gait state
  // ============================================================
  function makeFootState(side){
    return { side, groundY:null, contact:false, prev:{t:0,x:0,y:0,ok:false}, prevVY:0, active:null, lastTO:null, lastIC:null, lastIC_hipX:null };
  }
  const gait = { feet:{L:makeFootState('L'), R:makeFootState('R')}, steps:[], icTimes:[], recentWindow:6, vo:{baselineY:null, maxDevPx:0, windowFrames:0, lastVOcm:0} };
  let detectedIssues = new Set();

  // ============================================================
  // Charts + LPF
  // ============================================================
  let strideChart, stanceChart, kneeMSChart, grfCurveChart;
  const emaSeries = (vals, alpha=0.28)=>{ let prev=null; return vals.map(v=>{ if(v==null||!isFinite(v)) return null; if(prev==null){prev=v; return v;} prev=alpha*v+(1-alpha)*prev; return prev; }); };
  const sma = (vals, win=6)=>{ const out=[]; for(let i=0;i<vals.length;i++){ let s=0,c=0; for(let j=Math.max(0,i-win+1); j<=i; j++){ const v=vals[j]; if(v==null||!isFinite(v)) continue; s+=v; c++; } out.push(c? s/c:null); } return out; };

  function baseChartOptions(xTitle,yTitle){
    return {
      responsive:true, maintainAspectRatio:false, animation:false, normalized:true,
      interaction:{ mode:'index', intersect:false },
      plugins:{ legend:{ display:true, labels:{ boxWidth:10, boxHeight:10 } } },
      elements:{ point:{ radius:0, hitRadius:10 }, line:{ borderWidth:3, tension:0.35 } },
      scales:{ x:{ title:{ display:true, text:xTitle } }, y:{ title:{ display:true, text:yTitle } } }
    };
  }
  function initCharts(){
    strideChart = new Chart(document.getElementById('strideChart'), { type:'line', data:{labels:[], datasets:[{label:'Stride Length (cm) (LPF)', data:[]}]}, options: baseChartOptions('Step #','cm') });
    stanceChart = new Chart(document.getElementById('stanceChart'), { type:'line', data:{labels:[], datasets:[{label:'Stance Time (s) (LPF)', data:[]},{label:'Swing Time (s) (LPF)', data:[]}]}, options: baseChartOptions('Step #','seconds') });
    kneeMSChart = new Chart(document.getElementById('kneeMSChart'), { type:'line', data:{labels:[], datasets:[{label:'Knee Flexion Mid-Stance L (¬∞) (LPF)', data:[]},{label:'Knee Flexion Mid-Stance R (¬∞) (LPF)', data:[]}]}, options: baseChartOptions('Step #','degrees') });
    grfCurveChart = new Chart(document.getElementById('grfCurveChart'), { type:'line', data:{labels:[], datasets:[{label:'GRF Proxy (BW) (smoothed)', data:[]}]}, options: baseChartOptions('ms from IC','BW (proxy)') });
  }
  function numOrNull(v){ return (typeof v==='number' && isFinite(v)) ? v : null; }

  function updateChartsFromSteps(){
    const slice = gait.steps.slice(Math.max(0, gait.steps.length-120));
    const labels = slice.map(s=>String(s.idx));

    strideChart.data.labels = labels;
    strideChart.data.datasets[0].data = emaSeries(slice.map(s=>numOrNull(s.strideCm)));
    strideChart.update('none');

    stanceChart.data.labels = labels;
    stanceChart.data.datasets[0].data = emaSeries(slice.map(s=>numOrNull(s.stanceTimeS)));
    stanceChart.data.datasets[1].data = emaSeries(slice.map(s=>numOrNull(s.swingTimeS)));
    stanceChart.update('none');

    kneeMSChart.data.labels = labels;
    kneeMSChart.data.datasets[0].data = emaSeries(slice.map(s=>s.side==='L'?numOrNull(s.kneeMidStanceDeg):null),0.30);
    kneeMSChart.data.datasets[1].data = emaSeries(slice.map(s=>s.side==='R'?numOrNull(s.kneeMidStanceDeg):null),0.30);
    kneeMSChart.update('none');

    rebuildStepPicker();
  }
  function rebuildStepPicker(){
    if(!gait.steps.length){ stepPicker.innerHTML='<option value="">(no steps yet)</option>'; return; }
    const cur=stepPicker.value;
    stepPicker.innerHTML = gait.steps.slice(-200).map(s=>{
      const ttp=(typeof s.grfTimeToPeakMs==='number')?`${Math.round(s.grfTimeToPeakMs)}ms`:'‚Äî';
      const peak=(typeof s.grfPeakBW==='number')?s.grfPeakBW.toFixed(2):'‚Äî';
      return `<option value="${s.idx}">#${s.idx} (${s.side}) peak ${peak}BW, TTP ${ttp}</option>`;
    }).join('');
    if(cur && gait.steps.some(s=>String(s.idx)===cur)) stepPicker.value=cur;
    else stepPicker.value=String(gait.steps[gait.steps.length-1].idx);
    renderSelectedGRFCurve();
  }
  function renderSelectedGRFCurve(){
    const v=stepPicker.value;
    if(!v) return;
    const s=gait.steps.find(x=>String(x.idx)===v);
    if(!s || !s.grfCurve || !s.grfCurve.length){
      grfCurveChart.data.labels=[]; grfCurveChart.data.datasets[0].data=[]; grfCurveChart.update('none'); return;
    }
    const labels=s.grfCurve.map(p=>String(Math.round(p.tRelMs)));
    const raw=s.grfCurve.map(p=>p.bw);
    const sm=sma(raw,6);
    grfCurveChart.data.labels=labels;
    grfCurveChart.data.datasets[0].data=sm;
    grfCurveChart.update('none');
  }

  // ============================================================
  // UI helpers
  // ============================================================
  function viewMode(){ return viewModeEl.value; }
  function syncModeUI(){
    const m=viewMode();
    modePill.textContent=m.toUpperCase();
    if(m==='sagittal'){ modePill.style.background='#667eea'; modeMetricLabel.textContent='Overstride Risk (last IC)'; if(!modeMetricValue.textContent) modeMetricValue.textContent='Low'; }
    else { modePill.style.background='#e67e22'; modeMetricLabel.textContent='Knee Medial Drift (proxy) - live'; if(!modeMetricValue.textContent.includes('¬∞')) modeMetricValue.textContent='0.0¬∞'; }
  }
  function setSourceUI(mode){
    sourceMode=mode;
    sourcePill.textContent = mode.toUpperCase();
    sourcePill.style.background = (mode==='camera') ? '#16a085' : (mode==='video') ? '#f39c12' : '#2c3e50';
    sourceNote.textContent = (mode==='camera') ? 'Source: camera stream' : (mode==='video') ? 'Source: uploaded video file' : 'Source: none';
    videoControlsPanel.style.display = (mode==='video') ? 'block' : 'none';
  }
  function setPhaseIndicator(phase){
    for(let i=1;i<=4;i++) document.getElementById('phase'+i).classList.toggle('active', i===phase);
  }
  function setRecordButtonUI(){
    recordBtn.classList.toggle('recording', isRecording);
    recordBtn.textContent = isRecording ? 'Stop Recording' : 'Start Recording';
  }

  // ============================================================
  // Reset
  // ============================================================
  function resetGaitAll(){
    gait.feet.L=makeFootState('L'); gait.feet.R=makeFootState('R');
    gait.steps=[]; gait.icTimes=[];
    gait.vo={baselineY:null, maxDevPx:0, windowFrames:0, lastVOcm:0};
    detectedIssues=new Set();

    document.getElementById('issuesList').innerHTML='<div style="text-align:center; color:#999; padding:18px;">No issues detected yet</div>';
    document.getElementById('cadence').innerHTML=`0<span class="metric-unit">steps/min</span>`;
    document.getElementById('stanceTime').innerHTML=`0<span class="metric-unit">s</span>`;
    document.getElementById('swingTime').innerHTML=`0<span class="metric-unit">s</span>`;
    document.getElementById('strideLength').innerHTML=`0<span class="metric-unit">cm</span>`;
    document.getElementById('kneeMSL').innerHTML=`0<span class="metric-unit">¬∞</span>`;
    document.getElementById('kneeMSR').innerHTML=`0<span class="metric-unit">¬∞</span>`;
    document.getElementById('pelvicTilt').innerHTML=`0<span class="metric-unit">¬∞</span>`;
    document.getElementById('vertOsc').innerHTML=`0<span class="metric-unit">cm</span>`;
    document.getElementById('grfPeak').innerHTML=`0<span class="metric-unit">BW</span>`;
    document.getElementById('grfTTP').innerHTML=`0<span class="metric-unit">ms</span>`;
    document.getElementById('gaitPhase').textContent='Standing';
    setPhaseIndicator(1);

    exportBtn.disabled=true;

    if(strideChart){ strideChart.data.labels=[]; strideChart.data.datasets[0].data=[]; strideChart.update('none'); }
    if(stanceChart){ stanceChart.data.labels=[]; stanceChart.data.datasets[0].data=[]; stanceChart.data.datasets[1].data=[]; stanceChart.update('none'); }
    if(kneeMSChart){ kneeMSChart.data.labels=[]; kneeMSChart.data.datasets[0].data=[]; kneeMSChart.data.datasets[1].data=[]; kneeMSChart.update('none'); }
    if(grfCurveChart){ grfCurveChart.data.labels=[]; grfCurveChart.data.datasets[0].data=[]; grfCurveChart.update('none'); }
    rebuildStepPicker();
  }

  // ============================================================
  // TF backend init (with warm-up to avoid Safari ‚Äúhang‚Äù)
  // ============================================================
  async function initTFBackend(){
    setStatus('loading','<span class="loading-spinner"></span> TFJS: tf.ready()‚Ä¶');
    await tf.ready();

    const desired = backendPreference
      ? [backendPreference]
      : (isIOS || isSafari) ? ['webgl','cpu'] : ['webgpu','webgl','cpu'];

    for (const b of desired){
      try{
        setStatus('loading', `<span class="loading-spinner"></span> TFJS: setBackend(${b})‚Ä¶`);
        await tf.setBackend(b);
        await tf.ready();

        // Warm-up: force kernel compile (prevents ‚Äúsilent hang‚Äù later)
        setStatus('loading', `<span class="loading-spinner"></span> TFJS: warming up (${b})‚Ä¶`);
        tf.tidy(()=>{
          const a=tf.randomUniform([64,64]);
          const c=a.matMul(a);
          c.dataSync(); // force execution
        });

        return tf.getBackend();
      }catch(e){
        console.warn('Backend failed:', b, e);
      }
    }
    throw new Error('No TFJS backend could be initialized.');
  }

  async function initModel(){
    initFallback.style.display='none';
    armInitWatchdog();

    const backend = await initTFBackend();

    setStatus('loading', `<span class="loading-spinner"></span> Pose model: creating MoveNet (${backend})‚Ä¶`);
    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.MoveNet,
      {
        modelType: (isIOS || isSafari)
          ? poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
          : poseDetection.movenet.modelType.SINGLEPOSE_THUNDER,
        enableTracking:true,
        trackerType: poseDetection.TrackerType.BoundingBox
      }
    );

    setStatus('loading', `<span class="loading-spinner"></span> UI: initializing charts‚Ä¶`);
    initCharts();
    syncModeUI();
    setSourceUI('none');

    disarmInitWatchdog();
    setStatus('ready', `‚úì Model Ready (backend: ${backend}) ‚Äî Choose Camera or Upload Video`);
    startCamBtn.disabled=false;
    loadVideoBtn.disabled=false;
  }

  // ============================================================
  // The rest: camera / video / analysis / export
  // ============================================================
  // (Kept minimal here so init-debug is the focus; your previous analysis code can be merged in.)
  // For now, we only prove init works and camera starts.
  let isInited = false;

  function stopLoops(){
    isRunning=false;
    if(animId) cancelAnimationFrame(animId);
    animId=null; vfcActive=false;
  }
  function stopStream(){
    if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  }
  function revokeVideoUrl(){
    if(videoObjectUrl){ URL.revokeObjectURL(videoObjectUrl); videoObjectUrl=null; }
  }
  function clearVideoSource(){
    try{ webcam.pause(); }catch(_){}
    webcam.removeAttribute('src');
    webcam.srcObject=null;
    webcam.load();
  }

  function stopRecording(){
    if(!isRecording) return;
    isRecording=false;
    setRecordButtonUI();
    exportBtn.disabled = gait.steps.length===0;
    setStatus('ready', `‚úì Recording stopped ‚Äî ${gait.steps.length} steps captured`);
    if (strideChart) updateChartsFromSteps();
  }

  function stopAll(){
    stopRecording();
    stopLoops();
    stopStream();
    revokeVideoUrl();
    clearVideoSource();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    fpsDisplay.textContent='FPS: 0';
    setSourceUI('none');

    playPauseBtn.disabled=true;
    stopBtn.disabled=true;
    recordBtn.disabled=true;
    exportBtn.disabled=true;
    snapshotBtn.disabled=true;

    stepBackBtn.disabled=true;
    stepFwdBtn.disabled=true;
    skipBackBtn.disabled=true;
    skipFwdBtn.disabled=true;

    setStatus('ready','Stopped. Choose Camera or Upload Video.');
  }

  function ensureSecureContextOrWarn(){
    const ok = window.isSecureContext || location.hostname==='localhost' || location.hostname==='127.0.0.1';
    if(!ok){
      initFallback.style.display='flex';
      setStatus('error','‚úó Camera requires HTTPS. GitHub Pages must be https://');
      throw new Error('Insecure context');
    }
    if(!navigator.mediaDevices?.getUserMedia){
      initFallback.style.display='flex';
      setStatus('error','‚úó getUserMedia not supported.');
      throw new Error('getUserMedia unavailable');
    }
  }

  async function startCamera(){
    try{
      if(!detector) return alert('Model not ready yet.');
      ensureSecureContextOrWarn();

      stopAll();
      resetGaitAll();
      setSourceUI('camera');

      setStatus('loading','<span class="loading-spinner"></span> Starting camera‚Ä¶');

      webcam.muted=true;
      webcam.playsInline=true;
      webcam.setAttribute('playsinline','');
      webcam.setAttribute('muted','');
      webcam.setAttribute('autoplay','');

      const baseConstraints = { audio:false, video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} } };
      let stream;
      try{ stream = await navigator.mediaDevices.getUserMedia(baseConstraints); }
      catch(e){ stream = await navigator.mediaDevices.getUserMedia({audio:false, video:true}); }

      mediaStream=stream;
      webcam.srcObject=stream;

      await new Promise(res=>webcam.onloadedmetadata=()=>res());

      // play must be in a gesture on iOS: but at least we surface the real error now
      await webcam.play();

      canvas.width = webcam.videoWidth||640;
      canvas.height = webcam.videoHeight||480;

      const track = stream.getVideoTracks()[0];
      try{ await track.applyConstraints?.({ frameRate:{ ideal:120, max:120 } }); }catch(_){}

      const settings = track?.getSettings?.() || {};
      const gotFps = settings.frameRate ? Math.round(settings.frameRate) : null;

      stopBtn.disabled=false;
      recordBtn.disabled=false;
      snapshotBtn.disabled=false;

      isRecording=false;
      setRecordButtonUI();

      setStatus('ready', gotFps ? `üé• Camera active (delivered ~${gotFps} fps).` : 'üé• Camera active.');
    }catch(e){
      console.error(e);
      initFallback.style.display='flex';
      setStatus('error','‚úó Camera Error: ' + (e?.message||e));
      setSourceUI('none');
    }
  }

  async function loadVideoFile(file){
    try{
      stopAll();
      resetGaitAll();

      setSourceUI('video');
      setStatus('loading','<span class="loading-spinner"></span> Loading video‚Ä¶');

      revokeVideoUrl();
      videoObjectUrl = URL.createObjectURL(file);

      webcam.muted=true;
      webcam.playsInline=true;
      webcam.setAttribute('playsinline','');
      webcam.setAttribute('muted','');

      webcam.src=videoObjectUrl;
      webcam.load();

      await new Promise((res,rej)=>{
        webcam.addEventListener('loadeddata', ()=>res(), {once:true});
        webcam.addEventListener('error', ()=>rej(new Error('Failed to load video')), {once:true});
      });

      canvas.width = webcam.videoWidth||640;
      canvas.height = webcam.videoHeight||480;

      stopBtn.disabled=false;
      recordBtn.disabled=false;
      snapshotBtn.disabled=false;
      playPauseBtn.disabled=false;

      stepBackBtn.disabled=false;
      stepFwdBtn.disabled=false;
      skipBackBtn.disabled=false;
      skipFwdBtn.disabled=false;

      isRecording=false;
      setRecordButtonUI();

      playPauseBtn.textContent='Play';
      updateSeekUI();
      videoMetaLabel.textContent = `Video: ${webcam.videoWidth}x${webcam.videoHeight}, duration ${formatTime(webcam.duration)}s`;

      setStatus('ready','üìº Video loaded. Press Play, or scrub.');
    }catch(e){
      console.error(e);
      initFallback.style.display='flex';
      setStatus('error','‚úó Video Error: ' + (e?.message||e));
      setSourceUI('none');
    }
  }

  async function togglePlayPause(){
    if(sourceMode!=='video' || !webcam.src) return;
    if(webcam.paused){
      await webcam.play();
      playPauseBtn.textContent='Pause';
    } else {
      webcam.pause();
      playPauseBtn.textContent='Play';
    }
  }

  function formatTime(sec){ return isFinite(sec) ? sec.toFixed(3) : '0.000'; }
  function updateSeekUI(){
    if(sourceMode!=='video') return;
    const dur=webcam.duration||0;
    const t=webcam.currentTime||0;
    const max=1000;
    seekBar.value = String(dur>0 ? Math.round((t/dur)*max) : 0);
    timeLabel.textContent = `${formatTime(t)} / ${formatTime(dur)}`;
  }
  function seekToBarValue(){
    const dur=webcam.duration||0;
    if(dur<=0) return;
    const v=Number(seekBar.value||0);
    webcam.currentTime = Math.min(dur, Math.max(0,(v/1000)*dur));
    updateSeekUI();
  }
  function frameStep(deltaFrames){
    if(sourceMode!=='video') return;
    if(!webcam.paused){ webcam.pause(); playPauseBtn.textContent='Play'; }
    const assumedFps=Math.max(10,Math.min(1000,Number(assumedFpsEl.value||240)));
    const stepFrames=Math.max(1,Number(frameStepModeEl.value||1));
    const dt=(deltaFrames*stepFrames)/assumedFps;
    const dur=webcam.duration||0;
    webcam.currentTime = Math.min(dur||Infinity, Math.max(0,(webcam.currentTime||0)+dt));
    updateSeekUI();
  }
  function skipSeconds(ds){
    if(sourceMode!=='video') return;
    if(!webcam.paused){ webcam.pause(); playPauseBtn.textContent='Play'; }
    const dur=webcam.duration||0;
    webcam.currentTime = Math.min(dur||Infinity, Math.max(0,(webcam.currentTime||0)+ds));
    updateSeekUI();
  }

  function toggleRecording(){
    isRecording = !isRecording;
    setRecordButtonUI();
    if(isRecording){
      resetGaitAll();
      exportBtn.disabled=true;
      setStatus('ready','üî¥ Recording‚Ä¶ (steps will populate charts once analysis is added back)');
    } else {
      exportBtn.disabled = gait.steps.length===0;
      setStatus('ready', `‚úì Recording stopped ‚Äî ${gait.steps.length} steps captured`);
      if (strideChart) updateChartsFromSteps();
    }
  }

  // Placeholder drawing to prove canvas works even before full analysis
  function drawSkeleton(){}

  // ============================================================
  // Events
  // ============================================================
  startCamBtn.addEventListener('click', startCamera);
  loadVideoBtn.addEventListener('click', ()=>videoFile.click());
  videoFile.addEventListener('change', async (e)=>{
    const file=e.target.files?.[0];
    if(!file) return;
    await loadVideoFile(file);
    videoFile.value='';
  });

  playPauseBtn.addEventListener('click', togglePlayPause);
  stopBtn.addEventListener('click', stopAll);

  recordBtn.addEventListener('click', toggleRecording);

  viewModeEl.addEventListener('change', syncModeUI);
  seekBar.addEventListener('input', ()=>{ if(sourceMode==='video') seekToBarValue(); });
  webcam.addEventListener('timeupdate', updateSeekUI);
  webcam.addEventListener('loadedmetadata', updateSeekUI);
  webcam.addEventListener('durationchange', updateSeekUI);

  stepBackBtn.addEventListener('click', ()=>frameStep(-1));
  stepFwdBtn.addEventListener('click', ()=>frameStep(+1));
  skipBackBtn.addEventListener('click', ()=>skipSeconds(-0.1));
  skipFwdBtn.addEventListener('click', ()=>skipSeconds(+0.1));

  stepPicker.addEventListener('change', renderSelectedGRFCurve);

  // ============================================================
  // Boot (with retry)
  // ============================================================
  async function boot(isRetry=false){
    try{
      initFallback.style.display='none';
      setStatus('loading','<span class="loading-spinner"></span> Initializing‚Ä¶');
      await initModel();

      stopBtn.disabled=true;
      recordBtn.disabled=true;
      exportBtn.disabled=true;
      snapshotBtn.disabled=true;
      playPauseBtn.disabled=true;

      isInited=true;
    }catch(e){
      console.error(e);
      initFallback.style.display='flex';
      setStatus('error','‚úó Init Error: ' + (e?.message||e) + '<br>Try Force WebGL or Force CPU.');
    }
  }

  // Start init
  boot(false);
</script>
</body>
</html>
